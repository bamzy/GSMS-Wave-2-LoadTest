var dmu_ajax_version = "910.3"; //file version number
var dmu_debug = false; //output debug message to the console
var dmu_base_url = ""; //url that ajax calls should go to
var dmu_queries = 0; //number of queries currently running
var dmu_nkey = ""; //the security key for the session
var dmu_cache = new Object(); //array for caching results
var dmu_param = new Object(); //array for holding parameters
var dmu_chars = new Object(); //array for holding minimum query characters
var dmu_field = null; //input field currently in focus
var dmu_num_current = -1; //highlighted result row index
var dmu_obj_current = null; //highlighted result row object
var dmu_num_results = 0; //number of result rows
var dmu_obj_results = null; //list of result rows
var dmu_cur_value = ""; //current input field value
var dmu_old_value = ""; //previous input field value
var dmu_ori_value = ""; //original input field value (before up/down pressed)
var dmu_timer_start; //used for performance benchmarking
var dmu_timer_main; //used to restart main loop (failsafe)
var dmu_counter = 0; //counter used to keep track of search results
var dmu_streetnames = false; //special case for streetnames
var dmu_trans = new Object(); //array for holding translation field ids
var dmu_disps = new Object(); //array for holding display modes
var dmu_tvals = new Object(); //array for holding translation modes
var dmu_visible = false; //indicates whether the results are visible
var dmu_global_events = false; //indicates whether the window events have been registered
var dmu_pre_array = new Object(); //array for holding "pre" part of query string (nam~val)
var dmu_resize_count = 0; //used to resize during transitions
var dmu_padding_total = -1; //cache total padding of suggest box for resizing
var dmu_field_id = ""; //id of input field currently in focus (used to fix IE extra focus events)
var dmu_ignore_blur = false; //indicates the results box has been clicked and blur should be ignored

//Initialisation
if(typeof(sits_ajax_version)!="string") {
  sits_putmess("Required file 'sits_ajax.js' not found");
}
else if(sits_ajax_version<910.1) {
  sits_putmess("Required file 'sits_ajax.js' is out of date");
}

//First function - registers all the events
InstallAjax = function(frm,fld,btn,url) {
  if(dmu_debug) {
    sits_putmess("InstallAjax("+sits_to_string(frm)+","+sits_to_string(fld)+","+sits_to_string(btn)+","+sits_to_string(url)+")");
  }
  if(fld) { //field
    if(fld.id=="" || fld.name=="") {
      sits_putmess("InstallAjax: Specified field has no id or name");
      return false;
    }
    fld.autocomplete = "off";
  }
  else {
    sits_putmess("InstallAjax: No field specified");
    return false;    
  }
  if(frm) { //form
    sits_attach_event(frm,"submit",dmu_on_submit);
  }
  if(btn) { //button
    sits_putmess("Warning: Button specified"); //no code for this currently
  }
  if(url) { //absolute location
    dmu_base_url = url; //should this be global?
  }
  if(typeof($)!="function") { //check for jQuery
    if(dmu_debug) {
      sits_putmess("jQuery not ready yet - retry InstallAjax");
    }
    setTimeout("InstallAjax(null,document.getElementById(\""+fld.id+"\"),null,null);",100);
    return false;
  }
  var fld_jq = $(fld).attr("aria-haspopup","true").attr("aria-autocomplete","none").attr("aria-expanded",false); //accessibility
  var div = $("#"+sits_do_get_object(fld.id)+"_display"); //create display if it doesn't exist
  if(div.length==0) {
    fld_jq.after("<span id=\""+fld.id+"_display\" class=\"dmu_display sv-suggest-box-display sv-hide\"></span>");
  }
  if(!dmu_global_events) {
    $(window).on("resize scroll",sits_debounce_event(dmu_on_resize,250)).on("blur",dmu_on_blur); //register window events
    $(document).on("keydown",dmu_on_keydown).on("mousedown",dmu_on_blur); //register document events    
    dmu_global_events = true;
  }
  fld_jq.on("focus",dmu_on_focus).on("blur",dmu_on_blur).on("keyup",dmu_on_keyup).on("keypress",dmu_on_keypress).on("cut paste",dmu_on_cut_paste);
  fld_jq.parents("div.ui-dialog").on("resize",sits_debounce_event(dmu_on_resize,250));
  dmu_cache[fld.id] = new Array(new Array(),new Array(),new Array()); //initialise cache
  return true;
};

//Second function - defines the query parameters
SetupCall = function(p1,p2,p3,p4,p5,p6,p7,p8) {
  if(dmu_debug) {
    sits_putmess("SetupCall("+p1+","+p2+","+p3+","+p4+","+p5+","+p6+","+p7+","+p8+")");
  }
  if(p1=="" || typeof(p1)=="undefined") {
    sits_putmess("SetupCall: Field not specified");
    return false;
  }
  if(typeof(p2)=="undefined") {
    p2 = ""; //switches can be blank
  }
  if(typeof(p3)=="undefined" || p3=="") {
    sits_putmess("SetupCall: Dictionary not specified");
    return false;
  }
  if(typeof(p4)=="undefined" || p4=="") {
    sits_putmess("SetupCall: Entity not specified");
    return false;
  }
  if(typeof(p5)=="undefined") {
    p5 = ""; //program can be blank
  }
  if(typeof(p6)=="undefined" || p6=="") {
    sits_putmess("SetupCall: Retrieve profile not specified");
    return false;
  }
  if(typeof(p7)=="undefined" || p7=="") {
    sits_putmess("SetupCall: Return fields not specified");
    return false;
  }
  if(typeof(p8)=="undefined" || p8=="") {
    p8 = "-1"; //assume all records
  }
  var fld = dmu_get_object(p1); //get field object by name or id
  if(!fld || !fld.id) {
    return false;
  }
  p1 = fld.id; //use id instead of name
  var id = "";
  var i = p2.indexOf("INCTRAN="); //check translation field
  if(i>-1) {
    id = sits_get_item(p2,"INCTRAN",";");
    p2 = sits_del_item(p2,"INCTRAN",";");
    if(id=="Y") {
      id = p1+"_trans";
    }
  }
  dmu_trans[p1] = id;
  dmu_param[p1] = "&"+p2+"&"+p3+"&"+p4+"&"+p5+"&"+sits_escape_url(p6)+"&"+sits_escape_url(p7)+"&"+p8+"&";
  i = p2.indexOf("INCCHAR="); //check minimum query characters
  if(i>-1) {
    i = parseInt(p2.substr(i+8),10);
    if(isNaN(i) || i<1) {
      dmu_chars[p1] = "1";
    }
    else {
      dmu_chars[p1] = ""+i;
    }
  }
  else {
    dmu_chars[p1] = "1";
  }
  i = p2.indexOf("INCDISP="); //check display mode
  if(i>-1) {
    i = parseInt(p2.substr(i+8),10);
    if(isNaN(i) || i<1) {
      dmu_disps[p1] = "1";
    }
    else {
      dmu_disps[p1] = ""+i;
    }
  }
  else {
    dmu_disps[p1] = "1";
  }
  i = p2.indexOf("INCTVAL="); //check translation mode
  if(i>-1) {
    i = parseInt(p2.substr(i+8),10);
    if(isNaN(i) || i<1) {
      dmu_tvals[p1] = "2";
    }
    else {
      dmu_tvals[p1] = ""+i;
    }
  }
  else {
    dmu_tvals[p1] = "2";
  }
  $(fld).removeClass("sv-disabled dmu_disabled").addClass("dmu_enabled").removeAttr("aria-disabled");
  var val = sits_get_value(fld); //get field value
  if(val.length>=parseInt(dmu_chars[p1],10)) { //check value length against minimum
    sits_attach_event(window,"load",function() {
      if(dmu_disps[p1]=="1") {
        dmu_on_translate(true,fld); //translate now
      }
      else {
        $(fld).data("dmu-code","").data("dmu-orig",val).data("dmu-curr",val); //store initial values
        if(dmu_debug) {
          sits_putmess("dmu-code->");
          sits_putmess("dmu-orig->"+val);
          sits_putmess("dmu-curr->"+val);
        }
        dmu_ajax_send(p1,val); //call to server to fetch results
      }
    });
  }
  return true;
};

//Third function - re-defines the query parameters and clears cache
ReSetupCall = function(p1,p2,p3,p4,p5,p6,p7,p8) {
  if(dmu_debug) {
    sits_putmess("ReSetupCall("+p1+","+p2+","+p3+","+p4+","+p5+","+p6+","+p7+","+p8+")");
  }
  var boo = true;
  if(typeof(p2)=="undefined" && typeof(dmu_param[p1])=="string") {
    var fld = dmu_get_object(p1);
    $(fld).removeClass("sv-disabled dmu_disabled").addClass("dmu_enabled").removeAttr("aria-disabled"); //re-enable events
  }
  else {
    boo = SetupCall(p1,p2,p3,p4,p5,p6,p7,p8); //update parameters
  }
  if(boo) {
    for(var key in dmu_cache) {
      if(key.indexOf(p1)==0) {
        delete dmu_cache[key]; //clear cache
      }
    }
    dmu_cache[p1] = new Array(new Array(),new Array(),new Array()); //initialise cache
    return true;
  }
  return false;
}

//Fourth function - disables the dynamic listbox
UnSetupCall = function(p1) {
  var fld = dmu_get_object(p1);
  $(fld).removeClass("dmu_enabled").addClass("sv-disabled dmu_disabled").attr("aria-disabled","true"); //disable events
  dmu_hide_results(); //hide results
  dmu_field = null;
  dmu_field_id = "";
  return true;
}

//Focus event - initialises field and values
function dmu_on_focus(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_focus("+sits_to_string(e)+")");
  }
  dmu_field = sits_get_target(e);
  if(dmu_field) {
    var fld_jq = $(dmu_field);
    if(dmu_field_id!="" && fld_jq.attr("id")==dmu_field_id) { //field already focused (fixes IE issue)
      return true;
    }
    if(fld_jq.hasClass("dmu_disabled")) { //listbox disabled
      dmu_field = null;
      dmu_field_id = "";
      return true;
    }
    dmu_field_id = fld_jq.attr("id"); //store id
    var val = fld_jq.val();
    fld_jq.data("dmu-valu",val).data("dmu-curr",val); //store initial field value
    if(dmu_debug) {
      sits_putmess("dmu-valu->"+val);
      sits_putmess("dmu-curr->"+val);
    }
    if(fld_jq.hasClass("sv-suggest-box-input-icon")) {
      var spn = $("#"+sits_do_get_object(dmu_field.id)+"_display"); //get display element
      val = spn.text(); //get displayed value
      fld_jq.val(val).removeClass("sv-suggest-box-input-icon").data("dmu-code","").data("dmu-init",val); //reset field value
      if(dmu_debug) {
        sits_putmess("dmu-code->");
        sits_putmess("dmu-init->"+val);
      }
      sits_hide(spn); //hide displayed value
      spn.empty(); 
      sits_selection_end(dmu_field);
    }
    dmu_cur_value = val; //set current value
    $("#dmu_results_div").remove(); //remove any existing results    
		var con = "<div class=\"sv-suggest-box-content\">"; //build content
		con += "<div class=\"sv-suggest-box-overflow-hidden\">";
		con += "<div class=\"sv-list-group\" role=\"listbox\" aria-multiselectable=\"false\">";
		con += "</div></div></div>";    
    var div = $("<div>").attr("id","dmu_results_div").attr("tabindex","-1").html(con); //add new results div   
    div.addClass("sv-suggest-box"); 
    sits_hide(div); //make hidden for now
    div.insertAfter(fld_jq); //add after field
    $("#dmu_results_div").on("mousedown","a.sv-list-group-item",dmu_on_mousedown) //delegate events
                         .on("mouseover","a.sv-list-group-item",dmu_on_mouseover)
                         .on("mouseout","a.sv-list-group-item",dmu_on_mouseout)
                         .on("click","a.sv-list-group-item",sits_cancel_event);
  }
  else {
    dmu_cur_value = "";
  }
  dmu_old_value = dmu_ori_value = dmu_cur_value;
  dmu_num_current = -1;
  dmu_num_results = 0;
  dmu_obj_current = null;
  dmu_obj_results = null;
  if(((new Date).getTime())-dmu_timer_main>2000) {
    setTimeout("dmu_main_loop(true)",100); //restart main loop
  }
  return true;
}

//Blur event - translate value and hide results
function dmu_on_blur(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_blur("+sits_to_string(e)+")");
  }
  if(dmu_field) {
    if(dmu_ignore_blur || $(dmu_field).hasClass("dmu_disabled")) {
      dmu_ignore_blur = false;
      return true;
    }
    var trg = sits_get_target(e); //get target field object
    if(trg.id==dmu_field.id && trg.id!=e.currentTarget.id) {
      dmu_ignore_blur = false;
      return true; //event fired by field but not leaving field
    }
    if(trg.id=="dmu_results_div" || (typeof(trg.className)=="string" ? trg.className.indexOf("dmu_element_") : 0)>-1) {
      dmu_ignore_blur = true;
      return true; //clicked on results - not leaving field
    }
    dmu_ignore_blur = false;
    dmu_do_blur(); //handle leaving field
  }
  return true;
}

function dmu_do_blur() {
  if(dmu_debug) {
    sits_putmess("dmu_do_blur()");
  }
  if(dmu_field) {
    var fld_jq = $(dmu_field);
    if(fld_jq.hasClass("dmu_disabled")) {
      return true;
    }
    if(fld_jq.data("dmu-code")=="" && fld_jq.val()==fld_jq.data("dmu-init")) {
      fld_jq.val(fld_jq.data("dmu-valu")); //restore value to initial field value
    }
    else {
      if(!fld_jq.hasClass("sv-suggest-box-input-icon")) {
        var val = fld_jq.val(); //get current value
        fld_jq.data("dmu-curr",val); //store current value
        fld_jq.data("dmu-orig",dmu_ori_value); //store original value
        if(dmu_debug) {
          sits_putmess("dmu-curr->"+dmu_ori_value);
          sits_putmess("dmu-orig->"+dmu_ori_value);
        }
      }
    }
    dmu_on_translate(true,dmu_field);
    if(dmu_streetnames && dmu_num_current>-1) {
      dmu_on_streetname(dmu_num_current); //special case for streetnames
    }
    dmu_hide_results(); //hide results
    dmu_field = null;
    dmu_field_id = "";
  }
  return true;
}

//Submit event - hides results
function dmu_on_submit(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_submit("+sits_to_string(e)+")");
  }
  dmu_hide_results();
  dmu_field = null;
  dmu_field_id = "";
  return true;
}

//Resize event - resizes and positions results
function dmu_on_resize(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_resize("+sits_to_string(e)+")");
  }
  if(dmu_field && dmu_visible) {
    var fld_jq = $(dmu_field);
    if(fld_jq.hasClass("dmu_disabled")) {
      return true;
    }
    var div = sits_get_object("dmu_results_div");
    if(div) {
      var pos = dmu_field_position(dmu_field); //set position of results relative to input field
      var off = dmu_field_offset(dmu_field);
      var siz = sits_object_size(dmu_field);
      var lft = pos.x;
      var top = pos.y+siz.y; //position under field
      var gap = 0;
      var scx = 0;
      var scy = 0;
      var div_jq = $(div).removeAttr("style"); //clear styles from last resize
      sits_show(div_jq);
      dmu_check_width(div_jq); //calculate the new width (needs to be calculated before height because of stack mode)
      var hgt = div_jq.height(); //height of all results
      var dlg = $(dmu_field).parents("div.ui-dialog-content"); //check if inside dialog
      if(dlg.length>0) {
        gap = parseInt(dlg.outerHeight(),10); //bottom of the dialog
        var boo = true;
        var tmp = div_jq.parent();
        var did = dlg.attr("id");
        while(boo && tmp.attr("id")!=did) { //loop up through parents until the dialog
          if(tmp.css("position")=="relative") { //check if they are position relatively
            boo = false; //if so, ignore dialog scrolling
          }
          else {
            tmp = tmp.parent();
          }
        }
        if(boo) { 
          scx = dlg.get(0).scrollLeft; //account for scrolled dialog contents (if no relatively positioned parents)
          scy = dlg.get(0).scrollTop;
          gap -= (pos.y+siz.y); //bottom of the dialog
        }
        else {
          gap -= ((off.y-dlg.offset().top)+siz.y); //bottom of the dialog (relatively position parents)
        }
      }
      else {
        gap = sits_window_size().y+sits_scroll_offset().y-off.y-siz.y-3; //bottom of the screen
      }
      var ofy = "hidden";
      if(hgt>gap) { //compare height of widget with gap available
        hgt = gap; //don't disappear off the screen		
        ofy = "scroll";
      }      
      lft = parseInt(lft+scx,10); //round values
      top = parseInt(top+scy,10);
      hgt = parseInt(hgt,10);      
      var obj = {}; //build up style object
      obj.left = lft+"px";
      obj.top = top+"px";
      obj.height = hgt+"px";
      obj.overflowY = ofy;
      obj.overflowX = "hidden";      
      div_jq.css(obj); //update element
      if(e) {
        setTimeout("dmu_on_resize()",100); //check again after a delay if resize event
        return true;
      }
      var cur = dmu_field_position(div); //get current position
      var cux = parseInt(cur.x+scx,10);
      var cuy = parseInt(cur.y+scy,10);
      if((cux!=lft || cuy!=top) && dmu_resize_count++<10) {
        setTimeout("dmu_on_resize()",100); //account for style transitions
        return true;
      }      
      return true;
    }
  }
  return false;
}

//Calculate field position
function dmu_field_position(o) {
  if(dmu_debug) {
    sits_putmess("dmu_field_position("+sits_to_string(o)+")");
  }
  var pos = $(o).position();
  var curleft = parseInt(pos.left,10);
  var curtop = parseInt(pos.top,10);
  return {x:curleft,y:curtop}; //return coordinates {x,y}
}

//Calculate field offset
function dmu_field_offset(o) {
  if(dmu_debug) {
    sits_putmess("dmu_field_offset("+sits_to_string(o)+")");
  }
  var pos = $(o).offset();
  var curleft = parseInt(pos.left,10);
  var curtop = parseInt(pos.top,10);
  return {x:curleft,y:curtop}; //return coordinates {x,y}
}

//Keydown event - handles backspace and escape
function dmu_on_keydown(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_keydown("+sits_to_string(e)+")");
  }
  if(dmu_field) {
    var fld_jq = $(dmu_field);
    if(fld_jq.hasClass("dmu_disabled")) {
      return true;
    }
    var esc = e.DOM_VK_ESCAPE || 27;
    var key = e.keyCode || e.which; //get character
    switch(key) {
      case 8: //backspace
        if(dmu_field.createTextRange && e.srcElement==dmu_field) { //IE only
          if(sits_selection_pos(dmu_field)==0) { //cursor at beginning
            if(sits_selection_len(dmu_field)==0) { //no characters selected
              sits_selection_end(dmu_field);
              return sits_cancel_event(e);
            }
          }
        }
        break;
      case 9: //tab
        var val = fld_jq.data("dmu-code");
        if(typeof(val)=="string" && val!="") {
          fld_jq.data("dmu-orig",dmu_ori_value); //store original value
          if(dmu_debug) {
            sits_putmess("dmu-orig->"+dmu_ori_value);
          }
          dmu_old_value = dmu_cur_value = val;
          sits_selection_end(dmu_field);
          dmu_on_translate(true);
          if(dmu_streetnames && dmu_num_current>-1) {
            dmu_on_streetname(dmu_num_current); //special case for streetnames
          }
          dmu_hide_results();          
        }
        dmu_do_blur(); //handle leaving field
        break;
      case esc: //escape
        dmu_hide_results();
        break;
    }
  }
  return true;
}

//Keypress event - handles return
function dmu_on_keypress(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_keypress(e)");
  }
  var key = e.keyCode || e.which;
  switch(key) {
    case 3: case 13: //return
      return sits_cancel_event(e);
  }
  return true;
}

//Keyup event - handles user input
function dmu_on_keyup(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_keyup(e)");
  }
  if(dmu_field) {
    var fld_jq = $(dmu_field);
    if(fld_jq.hasClass("dmu_disabled")) {
      return true;
    }
    var key = e.keyCode || e.which;
    dmu_cur_value = dmu_field.value;
    switch(key) {
      case 3: case 13: //return
        fld_jq.data("dmu-orig",dmu_ori_value); //store original value
        if(dmu_debug) {
          sits_putmess("dmu-orig->"+dmu_ori_value);
        }
        dmu_old_value = dmu_cur_value;
        sits_selection_end(dmu_field);
        dmu_on_translate(true);
        if(dmu_streetnames && dmu_num_current>-1) {
          dmu_on_streetname(dmu_num_current); //special case for streetnames
        }
        dmu_hide_results();
        dmu_field_id = "";
        setTimeout("$(dmu_field).focus()",0); //set focus back to field
        return sits_cancel_event(e);
      case 38: //up
        dmu_old_value = dmu_cur_value;
        if(dmu_highlight_row(dmu_num_current-1)) {
          dmu_scroll_results(-1); //highlight previous value
        }
        break;
      case 40: //down
        if(dmu_visible) {
          dmu_old_value = dmu_cur_value;
          if(dmu_highlight_row(dmu_num_current+1)) {
            dmu_scroll_results(1); //highlight next value
          }
        }
        else {
          dmu_old_value = ""; //trigger search results
        }
        break;
      default:
        dmu_ori_value = dmu_cur_value;
    }
  }
  return true;
}

//Paste event - handles user input
function dmu_on_cut_paste(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_cut_paste(e)");
  }
  setTimeout("dmu_do_cut_paste()",0); //run later
  return true;
}

//Paste helper - value not ready during event
function dmu_do_cut_paste() {
  if(dmu_debug) {
    sits_putmess("dmu_do_cut_paste()");
  }
  if(dmu_field) {
    if($(dmu_field).hasClass("dmu_disabled")) {
      return true;
    }
    dmu_cur_value = dmu_field.value; //update value
  }
  return true;
}

//Highlights a row in the results list
function dmu_highlight_row(i) {
  if(dmu_debug) {
    sits_putmess("dmu_highlight_row("+i+")");
  }
  if(!dmu_obj_results || dmu_num_results<1) {
    var val = dmu_cur_value.toUpperCase();
    var len = parseInt(dmu_chars[dmu_field.id],10); //check minimum length
    if(val.length>=len) {
      var res = dmu_cache[dmu_field.id+val]; //check cache
      if(res) {
        dmu_build_results(res[0],res[1],res[2]); //display results
      }
    }
    return false; //results list not available
  }
  if(i>=dmu_num_results) {
    i = dmu_num_results-1; //select last if index out of bounds
  }
  if(dmu_num_current!=-1 && dmu_num_current!=i) { //un-highlight previous suggestion
    $(dmu_obj_current).removeClass("sv-active dmu_element_b").addClass("dmu_element_a");
    dmu_num_current = -1;
  }
  if(i<0) {
    dmu_num_current = -1; //moved up out of list
    $(dmu_field).val(dmu_ori_value).removeAttr("aria-activedescendant").focus();
    return false;
  }
  dmu_obj_current = dmu_obj_results.get(i);
  var cod = dmu_get_value(dmu_obj_current); //get code or name (depending on display mode)
  if(cod=="") {
    dmu_obj_current = null;
    $(dmu_field).removeAttr("aria-activedescendant");
    return false; //don't highlight if record count
  }
  if(dmu_num_current!=i) { //highlight new suggestion
    dmu_num_current = i;
    $(dmu_obj_current).removeClass("dmu_element_a").addClass("sv-active dmu_element_b");
  }
  $(dmu_field).val(cod).attr("aria-activedescendant",$(dmu_obj_current).attr("id")); //update field value
  sits_selection_end(dmu_field);
  return true;
}

//Returns the field object (by name or id)
function dmu_get_object(nam) {
  var fld = sits_get_object(nam,"name"); //get field object by name
  if(!fld) {
    fld = sits_get_object(nam); //get field object by id
  }
  return fld;
}

//Returns the code or name (depending on display mode) from the specified results row
function dmu_get_value(div) {
  if(dmu_debug) {
    sits_putmess("dmu_get_value("+sits_to_string(div)+")");
  }
  var val = "";
  if(div && dmu_field) {
    val = dmu_get_code(div); //get code
    $(dmu_field).data("dmu-code",val).data("dmu-curr",val); //store code
    if(dmu_debug) {
      sits_putmess("dmu-code->"+val);
      sits_putmess("dmu-curr->"+val);
    }
    if(val!="") {
      switch(dmu_disps[dmu_field.id]) {
        case "2":
          val = dmu_get_code(div,"dmu_element_d"); //get short name
          break;
         case "3":
          val = dmu_get_code(div,"dmu_element_g"); //get full name
          break;
      }
    }
  }
  return val; //return value
}

//Scrolls the results box so the highlight row is visible
function dmu_scroll_results(dir) {
  if(!dmu_obj_current || dmu_num_current<0 || dmu_num_results<1) {
    return false;
  }
  var div = sits_get_object("dmu_results_div"); //get results box
  if(div) {
    if(div.style.overflowY=="scroll") { //check for scrollbar
      var top = dmu_obj_current.offsetTop; //top of current item
      if(dir==1) { //down arrow?
        var row = dmu_obj_current.clientHeight;   // Height of current row
        var box = sits_object_size(div).y;                      // Bottom of results box
        if(top+row>box) {    // If top + height of current item is greater than depth of selection box
          div.scrollTop = top+row-box+4;    // Scroll box down to make the entire row visible
        }
      }
      else { //up arrow?
        if(top<div.scrollTop) {
          div.scrollTop = top; // Position current/highlighted row at top of selection box
        }
      }
      return true;
    }
  }
  return false;
}

//Populates the results box with the results rows
function dmu_build_results(cs,ds,es) {
  if(dmu_debug) {
    sits_putmess("dmu_build_results("+sits_to_string(cs)+","+sits_to_string(ds)+","+sits_to_string(es)+")");
  }
  var div = $("#dmu_results_div .sv-list-group").empty(); //remove previous results
  if(div.length==1) {    
    dmu_num_results = cs.length;
    for(var i=0;i<dmu_num_results;++i) { //create result rows
      var a = $("<a>").addClass("dmu_element_a sv-list-group-item").attr("role","option").attr("id","dmu_a"+i).attr("href","#");
      var l = $("<div>").addClass("dmu_element_l sv-list-group-item-heading").attr("id","dmu_l"+i); //list item
      var x = $("<div>").addClass("sv-clearfix");
      if(typeof(es)=="undefined") {
        l.addClass("dmu_element_2"); //2 columns
        var c = $("<div>").addClass("sv-suggest-box-code-col sv-text-nowrap dmu_element_c").text(cs[i]);
        var d = $("<div>").addClass("sv-suggest-box-snam-col sv-text-nowrap dmu_element_d").text(ds[i]);
        div.append(a.append(l.append(c).append(d).append(x)));
      }
      else {
        l.addClass("dmu_element_3"); //3 columns
        var e = $("<div>").addClass("sv-suggest-box-code-col sv-text-nowrap dmu_element_e").text(cs[i]);
        var f = $("<div>").addClass("sv-suggest-box-name-col sv-text-nowrap dmu_element_f").text(ds[i]);
        var g = $("<div>").addClass("sv-suggest-box-snam-col sv-text-nowrap dmu_element_g").text(es[i]);
        div.append(a.append(l.append(e).append(f).append(g).append(x)));
      }
    }
    dmu_obj_results = div.find("a.sv-list-group-item"); //get row objects
    dmu_num_current = -1;
    dmu_obj_current = null;
    if(dmu_cur_value=="" || dmu_num_results<1) {
      dmu_hide_results(); //hide if no results
    }
    else {
      dmu_show_results(); //show results
    }
  }
/* Performance benchmarking
  if(dmu_debug) {
    var diff = (new Date).getTime()-dmu_timer_start;
    sits_putmess(diff);
  }  */
  return true;
}

//Selects code when result row clicked
function dmu_on_mousedown(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_mousedown("+sits_to_string(e)+")");
  }
  var val = dmu_get_value(this); //get code or name (depending on display mode)
  if(val=="") {
    return sits_cancel_event(e); //cancel click
  }
  var fld_jq = $(dmu_field);
  fld_jq.data("dmu-orig",dmu_ori_value); //store original value
  if(dmu_debug) {
    sits_putmess("dmu-orig->"+dmu_ori_value);
  }
  dmu_old_value = dmu_ori_value = dmu_cur_value = dmu_field.value = val; //update to selected value
  dmu_on_translate(true);
  if(dmu_streetnames) {
    var nam = dmu_get_code(this,"dmu_element_d"); //get house numbers
    dmu_on_streetname(-1,val,nam); //special case for streetnames
  }
  dmu_hide_results();
  dmu_field_id = "";
  setTimeout("$(dmu_field).focus()",0); //set focus back to field    
  return true;
}

//Highlights result row when hovered over
function dmu_on_mouseover(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_mouseover("+sits_to_string(e)+")");
  }
  $(dmu_field).attr("aria-activedescendant",$(this).attr("id")); //accessibility
  return true;
}

//Unhighlights result row
function dmu_on_mouseout(e) {
  if(dmu_debug) {
    sits_putmess("dmu_on_mouseout("+sits_to_string(e)+")");
  }
  var act = $("#dmu_results_div a.sv-list-group-item.sv-active"); //check if there's an active list item
  if(act.length==1) {
    $(dmu_field).attr("aria-activedescendant",act.attr("id")); //accessibility
  }
  else {
    $(dmu_field).removeAttr("aria-activedescendant");
  }
  return true;
}

//Hides the results box and empties it
function dmu_hide_results() {
  if(dmu_debug) {
    sits_putmess("dmu_hide_results()");
  }
  var div = $("#dmu_results_div").removeAttr("style"); //hide results
  sits_hide(div);
  div.find(".sv-list-group").empty(); //remove old results 
  $(dmu_field).data("dmu-code","").removeAttr("aria-activedescendant").attr("aria-expanded",false); //accessibility
  dmu_visible = false;
  dmu_num_current = -1;
  dmu_num_results = 0;
  dmu_obj_current = null;
  dmu_obj_results = null;
  return true;
}

//Shows the results box and resizes/repositions it
function dmu_show_results() {
  if(dmu_debug) {
    sits_putmess("dmu_show_results()");
  }
  dmu_visible = true;
  dmu_resize_count = 0;
  dmu_on_resize(); //resize results (shows when ready)
  $(dmu_field).attr("aria-expanded",true); //accessibility
  return true;
}

//Check all values are visible in results box
function dmu_check_width(div) {
  if(dmu_debug) {
    sits_putmess("dmu_check_width("+sits_to_string(div)+")");
  }
  if(dmu_field && dmu_visible) {
    div = div || $("#dmu_results_div"); //get results div
    if(div.length==1) {
      var siz = sits_object_size(dmu_field); //get field dimensions
      var wdth = siz.x; //get width
      var maxc = 0;
      var maxd = 0;
      var maxe = 0;
      var maxf = 0;
      var maxg = 0;
      $("div.dmu_element_c",div).each(function(i) { //loop through codes
        this.style.width = "auto";
        if(this.offsetWidth>maxc) { //compare width with auto-width
          maxc = this.offsetWidth;
        }
        this.style.width = ""; //reset to original width
      });
      $("div.dmu_element_d",div).each(function(i) { //loop through names
        this.style.width = "auto";
        if(this.offsetWidth>maxd) { //compare width with auto-width
          maxd = this.offsetWidth;
        }
        this.style.width = ""; //reset to original width
      });
      $("div.dmu_element_e",div).each(function(i) { //loop through names
        this.style.width = "auto";
        if(this.offsetWidth>maxe) { //compare width with auto-width
          maxe = this.offsetWidth;
        }
        this.style.width = ""; //reset to original width
      });
      $("div.dmu_element_f",div).each(function(i) { //loop through names
        this.style.width = "auto";
        if(this.offsetWidth>maxf) { //compare width with auto-width
          maxf = this.offsetWidth;
        }
        this.style.width = ""; //reset to original width
      });
      $("div.dmu_element_g",div).each(function(i) { //loop through names
        this.style.width = "auto";
        if(this.offsetWidth>maxg) { //compare width with auto-width
          maxg = this.offsetWidth;
        }
        this.style.width = ""; //reset to original width
      });
      var neww = maxc+maxd+maxe+maxf+maxg; //calculate new width
      var scrl = true; //((div[0]).style.overflowY=="scroll"); //check for scrollbar
      neww += (scrl?17:0)+dmu_calc_padding(); //account for scrollbar and padding
      var pad = 5; //padding to each column
      neww += pad*(maxe>0?3:2); //2 or 3 columns
      if(wdth<neww) { //more width required
        var win = 0;
        var pos = dmu_field_offset(div).x; //field position left
        var dlg = div.parents("div.ui-dialog-content"); //check if inside dialog
        if(dlg.length>0) {
          win = dlg.width(); //dialog width
          pos -= dmu_field_offset(dlg).x;
        }
        else {
          win = $(document).width(); //window width
        }
        if(win<pos+neww) { //check width is available
          neww = Math.max(maxc,maxd,maxe,maxf,maxg)+pad; //responsive stacked mode
          maxc = neww-pad;
          maxd = neww-pad;
          maxe = neww-pad;
          maxf = neww-pad;
          maxg = neww-pad;
          neww += (scrl?17:0);        
          if(win<pos+neww) { //check width is available
            neww = win-pos-(scrl?17:0); //just use room available
            maxc = neww-pad;
            maxd = neww-pad;
            maxe = neww-pad;
            maxf = neww-pad;
            maxg = neww-pad;
            neww += (scrl?17:0);  
          }            
        }
      }
      div.width(Math.max(neww,wdth)); //set total width
      $("div.dmu_element_c",div).width(maxc+pad); //set column widths
      $("div.dmu_element_d",div).width(maxd+pad);
      $("div.dmu_element_e",div).width(maxe+pad);
      $("div.dmu_element_f",div).width(maxf+pad);
      $("div.dmu_element_g",div).width(maxg+pad);
    }
  }
  return false;
}

//Return total padding of suggest box for resizing
function dmu_calc_padding() {
  if(dmu_padding_total<0) { //check if it's been calculated yet
    dmu_padding_total = 0;
    var ele = $("#dmu_l0"); //start at first list element
    if(ele.length==1) {
      while(ele.attr("id")!="dmu_results_div") {
        dmu_padding_total += ele.outerWidth()-ele.width();
        ele = ele.parent();
      }
    }
  }
  return dmu_padding_total; //return padding
}

//Returns the code value from the specified results row
function dmu_get_code(div,ord) {
  if(dmu_debug) {
    sits_putmess("dmu_get_code("+sits_to_string(div)+","+ord+")");
  }
  var out = "";
  if(div) {
    var par = $(div); //jQuerify parent
    var val = ""
    var sel = ord || "dmu_element_c";
    var spn = $("div."+sel,par); //get div containing code
    if(spn.length==0) {
      switch(sel) {
        case "dmu_element_c":
          spn = $("div.dmu_element_e",par); //try 3 columns
          break;
        case "dmu_element_d":
          spn = $("div.dmu_element_f",par); //try 3 columns
          break;
      }
    }
    if(spn.length==1) {
      val = spn.text(); //get text value
      var l = val.length;
      var exc = "\n\r"; //exclude characters
      for(var i=0;i<l;i++) {
        var chr = val.charAt(i);
        if(exc.indexOf(chr)==-1) {
          out += chr;
        }
      }
    }
  }
  return out; //return value
}

//Make the call to the server to fetch results
function dmu_ajax_send(fid,val) {
  if(dmu_debug) {
    sits_putmess("dmu_ajax_send("+fid+","+val+")");
  }
  dmu_queries++; //increment concurrent counter
  var opt = {}; //build options
  opt.type = "POST";
  opt.url = dmu_base_url+"siw_dmu.get";
  opt.data = dmu_ajax_data(fid,val);
  opt.dataType = "html";
  opt.complete = function(xml,sts) { //attach event to handle results
    var res = xml.responseText;
    if(res.indexOf("dmu_process_results(")==0) {
      if(window.execScript) {
        window.execScript(res); //IE
      }
      else {
        window.setTimeout(res,0); //Other
      }
    }
    if(dmu_queries>0) {
      dmu_queries--; //decrement concurrent counter
    }
  };
  $.ajax(opt); //send ajax query
  return true;
}

//Builds the query string
function dmu_ajax_data(fid,val) {
  if(dmu_debug) {
    sits_putmess("dmu_ajax_data("+fid+","+val+")");
  }
  var pre = sits_escape_url(fid)+"~"+sits_escape_url(val); //build parameters
  var par = "&COUNTER="+(++dmu_counter)+";"+(dmu_param[fid]).substr(1); //increment query counter

  if(dmu_field!=null && dmu_field.id==fid) { 
    var dat = $(dmu_field).data("dmu-data"); //get data object
    if(dat && dat.prev) {
      if(dat.prev!="" && val.indexOf(dat.prev)==0) { //starts with previous value
        par = "&INCSOUR="+dat.sour+";"+par.substr(1); //add source to parameters
      }
    }
  }
  else {
    par = "&INCSOUR=T;"+par.substr(1); //running in translation mode
  }
  if(dmu_nkey=="") {
    dmu_nkey = $("input[name^=NKEY]").val(); //get security key
    dmu_nkey = sits_replace(dmu_nkey,String.fromCharCode(27),"\\;");
    dmu_nkey = sits_replace(dmu_nkey,"%1B","\\;");
    dmu_nkey = sits_replace(dmu_nkey,String.fromCharCode(21),"\\!");
    dmu_nkey = sits_replace(dmu_nkey,"%15","\\!");
    dmu_nkey = sits_escape_url(dmu_nkey);
  }
  dmu_pre_array[dmu_counter] = pre; //store "pre" part of query
  return pre+par+dmu_nkey; //return data string
}

//Processes the response from the query
dmu_process_results = function(is,cs,ds,js,es) {
  if(dmu_debug) {
    sits_putmess("dmu_process_results('"+is+"',"+sits_to_string(cs)+","+sits_to_string(ds)+","+sits_to_string(js)+","+sits_to_string(es)+")");
  }
  var boo = false;
  var cnt = 0;
  if(is!="") {
    cnt = sits_get_integer(is); //get query counter
    if(cnt>0 && cnt<=dmu_counter) {
      is = dmu_pre_array[cnt] || ""; //get "pre" part of query string
    }
    else {
      is = ""; //not in array
    }
  }
  if(is!="") { //check field id and value are populated
    delete dmu_pre_array[cnt];
    var arr = is.split("~"); //split id and value
    var fid = arr.shift();
    is = arr.join("~").toUpperCase(); //put value back together again
    dmu_cache[fid+is] = new Array(cs,ds,es); //cache results
    if(typeof(js)=="string") {
      var obj = sits_parse_json(js); //process extra data
      if(obj) {
        boo = true; //successful results
        if(obj.disp) {
          dmu_disps[fid] = obj.disp; //update display mode
        }
        if(dmu_field!=null && fid==dmu_field.id && !obj.tran) { //check results are for current field
          var dat = $(dmu_field).data("dmu-data") || {}; //get data object
          if(obj.cntr==dmu_counter) {
            dmu_build_results(cs,ds,es); //display results
            dat.prev = is; //update previous value
            if(obj.hash) {
              dat.hash = obj.hash; //update security hash
              dmu_param[fid] = "&INCHASH="+obj.hash+";"+(dmu_param[fid]).substr(1); //add hash to parameters
            }
            if(obj.sour) {
              dat.sour = obj.sour; //update previous source
            }
            else {
              if(obj.cols && obj.cols==3) { //set default source
                dat.sour = "6";
              }
              else {
                dat.sour = "B";
              }
            }
            if(obj.oslo) {
              dat.oslo = obj.oslo; //special case for streetnames
              dmu_streetnames = true;
            }
            $(dmu_field).data("dmu-data",dat); //store data object field
            if(dmu_debug) {
              sits_putmess("dmu-data->"+sits_to_string(dat));
            }
          }
        }
        else { //results are for another field
          var fld = dmu_get_object(fid); //get field object by name or id
          dmu_on_translate(false,fld); //display translation
        }
      }
    }
  }
  return boo;
}

//Continuous loop - checks if value has changed and initiates query
dmu_main_loop = function(boo) {
  if(dmu_debug && boo) {
    sits_putmess("dmu_main_loop(true)"); //only on first iteration
  }
  dmu_timer_main = (new Date).getTime();
  if(dmu_field!=null && dmu_old_value!=dmu_cur_value) { //check value changed
    if(dmu_debug) {
      sits_putmess("dmu_old_value="+dmu_old_value+" dmu_cur_value="+dmu_cur_value);
    }
    dmu_timer_start = (new Date).getTime();
    var val = dmu_cur_value.toUpperCase();
    var len = parseInt(dmu_chars[dmu_field.id],10); //check minimum length
    if(val.length<len) {
      dmu_hide_results(); //hide results
    }
    else {
      var res = dmu_cache[dmu_field.id+val]; //check cache
      if(res) {
        dmu_build_results(res[0],res[1],res[2]); //display results
      }
      else {
        dmu_ajax_send(dmu_field.id,val); //send call to server to fetch results
      }
    }
  }
  dmu_old_value = dmu_cur_value;
  setTimeout("dmu_main_loop(false)",(dmu_queries+3)*50); //continue to loop
  return true;
};
setTimeout("dmu_main_loop(true)",100); //initiate main loop

//Function to check that the value in a field object is valid - returns null if not valid (i.e. not the only value or no values found)
function checkDmuValue(fld){
  if(!fld) {
    return null; //no field object specified
  }

  var index = fld.id;
  var value = fld.value;
  if(value==null || value=="") {
    return value; //no value entered so just return blank (prevents error)
  }

  //check cache for the value - dmu_main_loop should already have run so assume results have been returned
  var res = dmu_cache[index+value.toUpperCase()];
  if(!res) {
    return value; //no values in cache which means value has not been changed so assume correct
  }

  var cacheValues = res[0]; //array of values that match
  if(cacheValues.length!=1) { //if more than one item then check and see if any items are a match for the value
    for(var i=0;i<cacheValues.length;i++) {
      if(cacheValues[i]==value) {
        return cacheValues[i];
      }
    }
    return null; //no match so return null
  }
  else {
    return (cacheValues[0]);
  }
}

//Function to populate extra fields - special case for streetnames
function dmu_on_streetname(num,val,nam) { 
  if(dmu_debug) {
    sits_putmess("dmu_on_streetname("+num+","+sits_to_string(val)+","+sits_to_string(nam)+")");
  }
  var dat = $(dmu_field).data("dmu-data"); //get data object
  if(dat && dat.oslo) {
    var arr = dat.oslo;
    if(num==-1 && typeof(val)=="string" && val.length>0) { //selected with mouse
      var l = dmu_obj_results.length;
      for(var i=0;i<l;i++) {
        if(val==dmu_get_code(dmu_obj_results.get(i))) { //search results for code...
          if(nam==dmu_get_code(dmu_obj_results.get(i),"dmu_element_d")) { //...and name
            num = i;
            i = l; //break out of loop
          }
        }
      }
    }
    if(num>-1 && num<arr.length) { //index in range
      var obj = arr[num];
      if(obj) {
        var fld = $("input[oslo=regn]");  
        if(fld.length==0) {
          var fld = $("input[addf=3]");
        }
        if(fld.length>0) {
          fld.val(obj.SND_REGN || ""); //set region field
        }
        fld = $("input[oslo=pcod]");     
        if(fld.length==0) {
          var fld = $("input[addf=P]");
        }
        if(fld.length>0) {
          fld.val(obj.SND_PCOD || ""); //set postcode field
        }
        $("input[sndf=stnc]").val(obj.SND_STNC || ""); //other SND fields
        $("input[sndf=seq3]").val(obj.SND_SEQ3 || "");
        $("input[sndf=hnms]").val(obj.SND_HNMS || "");
        $("input[sndf=regn]").val(obj.SND_REGN || "");
        $("input[sndf=pcod]").val(obj.SND_PCOD || "");
        $("input[sndf=name]").val(obj.SND_NAME || "");
        $("input[sndf=srtn]").val(obj.SND_SRTN || "");
        return true;
      }
    }
  }
  return false;
}

//Function to provide field translation
function dmu_on_translate(boo,fld_in) {
  if(dmu_debug) {
    sits_putmess("dmu_on_translate("+boo+","+sits_to_string(fld_in)+")");
  }
  var cur = false;
  if(!fld_in) {
    fld_in = dmu_field; //use current field by default
    cur = true;
  }
  if(fld_in) {
    var fld_jq = $(fld_in);
    if(fld_jq.hasClass("dmu_disabled") || fld_jq.hasClass("sv-suggest-box-input-icon")) {
      return true; //don't do anything if disabled or in icon mode
    }
    var cod = "";
    var val = fld_jq.val(); //get field value
    if(val!="") {
      switch(dmu_disps[fld_in.id]) { //check display mode
        case "1":
          val = val.toUpperCase(); //uppercase code
          cod = val;
          break;
        case "2": case "3":
          cod = fld_jq.data("dmu-code"); //get selected code
          if(typeof(cod)=="string") {
            if(cod=="" && !cur) { //initial translation mode
              var tmp = dmu_on_translate_get(fld_in,val,(dmu_disps[fld_in.id])-1,boo);
              if(tmp!="") {
                cod = val;
                val = tmp;
                fld_jq.data("dmu-code",cod); //store selected code
                if(dmu_debug) {
                  sits_putmess("dmu-code->"+cod);
                }
              }
            }
            if(cod!="") {
              fld_jq.val(cod).addClass("sv-suggest-box-input-icon");
              var spn = $("#"+sits_do_get_object(fld_in.id)+"_display"); //get display element
              spn.text(val); //display name instead
              sits_show(spn);
            }
          }
          break;
      }
    }
    if(dmu_trans[fld_in.id]) { //check if translation field specified
      var id = dmu_trans[fld_in.id];
      var fld = sits_get_object(id); //check translation field object
      if(!fld) {
        $("<div id=\""+id+"\" style=\"display:inline;padding-left:5px\"></div>").insertAfter(fld_jq); //create translation field
        fld = sits_get_object(id);
      }
      var txt = dmu_on_translate_get(fld_in,cod,(dmu_tvals[fld_in.id])-1,boo); //get translation
      return dmu_on_translate_set(fld,txt); //show translation
    }
  }
  return false;
}

//Function to check cache for translation and get if required
function dmu_on_translate_get(fld_in,val,ind,boo) {
  if(dmu_debug) {
    sits_putmess("dmu_on_translate_get("+sits_to_string(fld_in)+","+val+","+ind+","+boo+")");
  }
  if(fld_in) {
    if(val!="") {
      val = val.toUpperCase(); //uppercase code
      var len = (fld_in.id).length;
      for(var fid in dmu_cache) { //loop through entire cache
        if(fid.substr(0,len)==fld_in.id) {
          var codes = dmu_cache[fid][0]; //get array of codes
          var l = codes.length;
          var l = codes.length;
          if(l>0) {
            var names = dmu_cache[fid][ind]; //get array of names
            for(var i=0;i<l;i++) {
              if(codes[i]==val) { //check field value against code array
                return names[i]; //show translation
              }
            }
          }
        }
      }
      if(boo) {
        dmu_ajax_send(fld_in.id,val); //call to server to fetch results
      }
    }
  }
  return ""; //no translation
}

//Function to provide field translation
function dmu_on_translate_set(fld,trn) {
  if(dmu_debug) {
    sits_putmess("dmu_on_translate_set("+sits_to_string(fld)+","+trn+")");
  }
  if(!sits_set_value(fld,trn)) { //update translation field value...
    $(fld).text(trn); //...or translation element content
  }
  return true;
}

//Function called from "sits_set_value" for dynamic listboxes
function dmu_set_value(obj,val) { 
  if(dmu_debug) {
    sits_putmess("dmu_set_value("+sits_to_string(obj)+","+val+")");
  }
  var fld_jq = $(obj);
  if(fld_jq.hasClass("sv-suggest-box-input-icon")) {
    var spn = $("#"+sits_do_get_object(obj.id)+"_display"); //get display element
    fld_jq.val(val).removeClass("sv-suggest-box-input-icon").data("dmu-code","").data("dmu-init",val); //reset field value
    if(dmu_debug) {
      sits_putmess("dmu-code->");
      sits_putmess("dmu-init->"+val);
    }
    sits_hide(spn); //hide displayed value
    spn.empty(); 
  }        
  fld_jq.data("dmu-curr",val);
  obj.value = val;
  return dmu_on_translate(true,obj);
}